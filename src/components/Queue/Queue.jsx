import React, { useEffect, useState } from 'react'
import { useDispatch, useSelector } from 'react-redux'
import styles from "./Queue.module.css"
import { addTrackAtQueue, artistsTopTrackSearchRequest, playSongRequest, repeatModeChangeReq, shuffleModeChangeReq } from '../../store/reducers/mainMusicState'
import { fixSongDuration } from '../MiniPlayer/MiniPlayer'
import axios from 'axios'


const Queue = ({show}) => {
    const { token, tokenType, playerCurrentState, localQueue, playerReady, player, deviceId, playerIsPlaying, shuffleMode, repeatMode, autoQueueTracks } = useSelector((state) => state.mainMusicState)
    const { searchLoader, searchError, trackSearchResult, albumSearchResult, playlistSearchResult, artistSearchResult } = useSelector((state) => state.searchState)
    // const [ repeat, setRepeatMode ] = useState("off")
    // const [ snuffle, setShuffleMode ] = useState(false)
    const dispatch = useDispatch()
    const reqParams = {
        token: token,
        tokenType: tokenType,
        deviceId: deviceId,
    }

    useEffect(() => {
        console.log(localQueue);
    }, [localQueue])

    const changeRepeatMode = () => {
        if(repeatMode === 0) dispatch(repeatModeChangeReq({...reqParams, mode: "context"}))
        else if(repeatMode === 1) dispatch(repeatModeChangeReq({...reqParams, mode: "track"}))
        else dispatch(repeatModeChangeReq({...reqParams, mode: "off"}))
    }


    // useEffect(() => {
    //     axios.put(`https://api.spotify.com/v1/me/player/repeat?state=${repeatMode}&device_id=${deviceId}`, {}, {
    //         headers: {'Authorization': `${tokenType} ${token}`}
    //     }).then(() => {
    //         console.log("repeat mode ", repeatMode);
    //     }).catch(err => console.log(err))
    // }, [repeatMode])

    return (
    <div className={styles.queueParent}>
        <div>
            <span>
                <button onClick={() => {
                    changeRepeatMode()
                }} style={repeatMode !== 0 ? {background: "rgba(255, 255, 255, 0.96)"} : {}} 
                title="Repeat queue">
                    <svg style={repeatMode === 0 ? {opacity: "1"} : {opacity: "0"}} xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <path d="M4.71973 14.7409C4.71973 15.434 5.28223 15.9965 5.97531 15.9965C6.67843 15.9965 7.23089 15.434 7.23089 14.7409V14.088C7.23089 12.4508 8.35589 11.3961 10.0635 11.3961H17.607V13.4954C17.607 14.0981 17.9887 14.4798 18.6014 14.4798C18.8726 14.4798 19.1237 14.3793 19.3246 14.2186L23.2822 10.924C23.7744 10.5322 23.7644 9.86928 23.2822 9.46749L19.3246 6.16281C19.1237 5.99205 18.8726 5.8916 18.6014 5.8916C17.9887 5.8916 17.607 6.2733 17.607 6.87598V8.92508H10.2644C6.85924 8.92508 4.71973 10.8235 4.71973 13.847V14.7409ZM14.3927 17.4932C14.3927 16.8905 14.011 16.4987 13.4083 16.4987C13.1371 16.4987 12.876 16.6092 12.6751 16.7699L8.72754 20.0646C8.23535 20.4563 8.23535 21.1092 8.72754 21.5211L12.6751 24.8258C12.876 24.9965 13.1371 25.097 13.4083 25.097C14.011 25.097 14.3927 24.7153 14.3927 24.1126V22.0534H21.7454C25.1505 22.0534 27.28 20.145 27.28 17.1316V16.2376C27.28 15.5345 26.7275 14.972 26.0244 14.972C25.3313 14.972 24.7688 15.5345 24.7688 16.2376V16.8905C24.7688 18.5177 23.6539 19.5824 21.9362 19.5824H14.3927V17.4932Z" fill="white" fill-opacity="0.96"/>
                    </svg>
                    <svg style={repeatMode === 1 ? {opacity: "1"} : {opacity: "0"}} xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <path d="M4.71973 14.7411C4.71973 15.4341 5.28223 15.9966 5.97531 15.9966C6.67843 15.9966 7.23089 15.4341 7.23089 14.7411V14.0882C7.23089 12.4509 8.35589 11.3962 10.0635 11.3962H17.607V13.4955C17.607 14.0982 17.9887 14.4799 18.6014 14.4799C18.8726 14.4799 19.1237 14.3794 19.3246 14.2187L23.2822 10.9241C23.7744 10.5323 23.7644 9.8694 23.2822 9.46762L19.3246 6.16293C19.1237 5.99217 18.8726 5.89172 18.6014 5.89172C17.9887 5.89172 17.607 6.27342 17.607 6.8761V8.92521H10.2644C6.85924 8.92521 4.71973 10.8236 4.71973 13.8471V14.7411ZM14.3927 17.4933C14.3927 16.8906 14.011 16.4989 13.4083 16.4989C13.1371 16.4989 12.876 16.6094 12.6751 16.7701L8.72754 20.0647C8.23535 20.4565 8.23535 21.1094 8.72754 21.5212L12.6751 24.8259C12.876 24.9966 13.1371 25.0971 13.4083 25.0971C14.011 25.0971 14.3927 24.7154 14.3927 24.1127V22.0536H21.7454C25.1505 22.0536 27.28 20.1451 27.28 17.1317V16.2377C27.28 15.5346 26.7275 14.9721 26.0244 14.9721C25.3313 14.9721 24.7688 15.5346 24.7688 16.2377V16.8906C24.7688 18.5178 23.6539 19.5826 21.9362 19.5826H14.3927V17.4933Z" fill="#1C1C1C"/>
                    </svg>
                    <svg style={repeatMode === 2 ? {opacity: "1"} : {opacity: "0"}} xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <path d="M26.0548 12.9935C26.7579 12.9935 27.1698 12.6118 27.1698 11.8484V7.13745C27.1698 6.33388 26.6374 5.80151 25.8439 5.80151C25.201 5.80151 24.8093 6.00241 24.297 6.3841L23.0013 7.36848C22.6999 7.5995 22.5894 7.82049 22.5894 8.09169C22.5894 8.49348 22.8807 8.80486 23.3327 8.80486C23.5336 8.80486 23.7044 8.73455 23.8751 8.60397L24.8394 7.82049H24.9198V11.8484C24.9198 12.6118 25.3417 12.9935 26.0548 12.9935ZM4.70996 14.7412C4.70996 15.4544 5.25237 15.9968 5.96554 15.9968C6.68876 15.9968 7.22112 15.4544 7.22112 14.7412V14.0883C7.22112 12.4511 8.34612 11.3964 10.0537 11.3964H15.1363V13.4957C15.1363 14.0984 15.518 14.4801 16.1207 14.4801C16.3919 14.4801 16.653 14.3796 16.8539 14.2189L20.8115 10.9243C21.2937 10.5225 21.2937 9.86959 20.8115 9.46781L16.8539 6.16312C16.653 5.99236 16.3919 5.89192 16.1207 5.89192C15.518 5.89192 15.1363 6.27361 15.1363 6.87629V8.9254H10.2546C6.84947 8.9254 4.70996 10.8238 4.70996 13.8473V14.7412ZM14.383 17.4935C14.383 16.8908 14.0013 16.4991 13.3986 16.4991C13.1274 16.4991 12.8662 16.6095 12.6653 16.7703L8.71777 20.0649C8.22559 20.4566 8.22559 21.1096 8.71777 21.5214L12.6653 24.8261C12.8662 24.9968 13.1274 25.0973 13.3986 25.0973C14.0013 25.0973 14.383 24.7156 14.383 24.1129V22.0537H21.7356C25.1408 22.0537 27.2702 20.1453 27.2702 17.1319V16.2379C27.2702 15.5147 26.7278 14.9723 26.0146 14.9723C25.3015 14.9723 24.7591 15.5147 24.7591 16.2379V16.8908C24.7591 18.518 23.6441 19.5828 21.9265 19.5828H14.383V17.4935Z" fill="#1C1C1E"/>
                    </svg>
                </button>
                <button onClick={() => {
                    dispatch(shuffleModeChangeReq({...reqParams, mode: !shuffleMode}))
                }} style={shuffleMode ? {background: "rgba(255, 255, 255, 0.96)"} : {}} 
                title="Shuffle mode">
                    <svg style={shuffleMode ? {opacity: "0"} : {opacity: "1"}} xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <path d="M3.8158 20.9788C3.8158 21.692 4.34816 22.1942 5.11155 22.1942H7.48209C9.27004 22.1942 10.3549 21.6618 11.5703 20.2154L13.8504 17.5033L16.0903 20.1752C17.3359 21.6618 18.5613 22.2042 20.3593 22.2042H22.1473V24.404C22.1473 25.0067 22.529 25.3884 23.1417 25.3884C23.4129 25.3884 23.664 25.2879 23.8649 25.1272L27.8225 21.8326C28.3147 21.4308 28.3046 20.7779 27.8225 20.3761L23.8649 17.0714C23.664 16.9007 23.4129 16.8002 23.1417 16.8002C22.529 16.8002 22.1473 17.1819 22.1473 17.7846V19.7533H20.4095C19.2745 19.7533 18.5714 19.3817 17.7477 18.4074L15.4174 15.6451L17.7578 12.8627C18.5915 11.8683 19.2343 11.5268 20.3493 11.5268H22.1473V13.5257C22.1473 14.1283 22.529 14.51 23.1417 14.51C23.4129 14.51 23.664 14.4096 23.8649 14.2489L27.8225 10.9542C28.3147 10.5525 28.3046 9.89955 27.8225 9.49777L23.8649 6.19308C23.664 6.02232 23.4129 5.92188 23.1417 5.92188C22.529 5.92188 22.1473 6.30357 22.1473 6.90625V9.07589H20.3694C18.5111 9.07589 17.3359 9.59821 16.02 11.1853L13.8504 13.7667L11.5703 11.0647C10.3549 9.6183 9.19972 9.07589 7.41178 9.07589H5.11155C4.34816 9.07589 3.8158 9.58817 3.8158 10.3013C3.8158 11.0145 4.35821 11.5268 5.11155 11.5268H7.32138C8.4062 11.5268 9.12941 11.8884 9.95307 12.8728L12.2734 15.635L9.95307 18.4074C9.11937 19.3917 8.46647 19.7533 7.39169 19.7533H5.11155C4.35821 19.7533 3.8158 20.2656 3.8158 20.9788Z" fill="white" fill-opacity="0.96"/>
                    </svg>
                    <svg style={shuffleMode ? {opacity: "1"} : {opacity: "0"}} xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <path d="M3.81592 20.9788C3.81592 21.692 4.34828 22.1942 5.11168 22.1942H7.48221C9.27016 22.1942 10.355 21.6618 11.5704 20.2154L13.8505 17.5033L16.0905 20.1752C17.336 21.6618 18.5615 22.2042 20.3594 22.2042H22.1474V24.404C22.1474 25.0067 22.5291 25.3884 23.1418 25.3884C23.413 25.3884 23.6641 25.2879 23.865 25.1272L27.8226 21.8326C28.3148 21.4308 28.3048 20.7779 27.8226 20.3761L23.865 17.0714C23.6641 16.9007 23.413 16.8002 23.1418 16.8002C22.5291 16.8002 22.1474 17.1819 22.1474 17.7846V19.7533H20.4097C19.2746 19.7533 18.5715 19.3817 17.7478 18.4074L15.4175 15.6451L17.7579 12.8627C18.5916 11.8683 19.2344 11.5268 20.3494 11.5268H22.1474V13.5257C22.1474 14.1283 22.5291 14.51 23.1418 14.51C23.413 14.51 23.6641 14.4096 23.865 14.2489L27.8226 10.9542C28.3148 10.5525 28.3048 9.89955 27.8226 9.49777L23.865 6.19308C23.6641 6.02232 23.413 5.92188 23.1418 5.92188C22.5291 5.92188 22.1474 6.30357 22.1474 6.90625V9.07589H20.3695C18.5112 9.07589 17.336 9.59821 16.0202 11.1853L13.8505 13.7667L11.5704 11.0647C10.355 9.6183 9.19985 9.07589 7.4119 9.07589H5.11168C4.34828 9.07589 3.81592 9.58817 3.81592 10.3013C3.81592 11.0145 4.35833 11.5268 5.11168 11.5268H7.3215C8.40632 11.5268 9.12953 11.8884 9.95319 12.8728L12.2735 15.635L9.95319 18.4074C9.11949 19.3917 8.46659 19.7533 7.39181 19.7533H5.11168C4.35833 19.7533 3.81592 20.2656 3.81592 20.9788Z" fill="#1C1C1E"/>
                    </svg>
                </button>
            </span>
            <button>Clear All</button>
        </div>
        <div>
            {/* <div className={styles.playingNow}>
                <h3>Playing now</h3>
                <div style={localQueue !== null && localQueue.currently_playing !== null ? {} : {display: "none"}} className={styles.queueItem}>
                    <div className={`${styles.image} ${styles.currentlyPlayingImage}`}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36" fill="none">
                            <path d="M12.3837 26.9574H15.0393C16.1128 26.9574 16.6665 26.4037 16.6665 25.3301V9.78104C16.6665 8.68492 16.1128 8.16511 15.0393 8.15381H12.3837C11.3102 8.15381 10.7565 8.70752 10.7565 9.78104V25.3301C10.7452 26.4037 11.2989 26.9574 12.3837 26.9574ZM20.9719 26.9574H23.6162C24.6897 26.9574 25.2434 26.4037 25.2434 25.3301V9.78104C25.2434 8.68492 24.6897 8.15381 23.6162 8.15381H20.9719C19.8871 8.15381 19.3447 8.70752 19.3447 9.78104V25.3301C19.3447 26.4037 19.8871 26.9574 20.9719 26.9574Z" fill="white" fill-opacity="0.96"/>
                        </svg>
                        <img src={localQueue?.currently_playing?.album.images[0].url} alt="" />
                    </div>
                    <div className={styles.name}>
                        <span>
                            <h4>{localQueue?.currently_playing?.name}</h4>
                            <p>{fixSongDuration(localQueue?.currently_playing?.duration_ms)}</p>
                        </span>
                        <h5>{localQueue?.currently_playing?.artists[0].name}</h5>
                    </div>
                    <button>
                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36" fill="none">
                            <path d="M7.34363 9.6227H28.6332C29.2096 9.6227 29.6729 9.14809 29.6729 8.58308C29.6729 7.99547 29.2096 7.54346 28.6332 7.54346H7.34363C6.76732 7.54346 6.31531 8.00677 6.31531 8.58308C6.31531 9.14809 6.76732 9.6227 7.34363 9.6227ZM7.34363 15.544H28.6332C29.2096 15.544 29.6729 15.0694 29.6729 14.5044C29.6729 13.9168 29.2096 13.4648 28.6332 13.4648H7.34363C6.76732 13.4648 6.31531 13.9281 6.31531 14.5044C6.31531 15.0694 6.76732 15.544 7.34363 15.544ZM7.34363 21.4653H28.6332C29.2096 21.4653 29.6729 20.9907 29.6729 20.4257C29.6729 19.8494 29.2096 19.3861 28.6332 19.3861H7.34363C6.76732 19.3861 6.31531 19.8494 6.31531 20.4257C6.31531 20.9907 6.76732 21.4653 7.34363 21.4653ZM7.34363 27.3866H28.6332C29.2096 27.3866 29.6729 26.912 29.6729 26.347C29.6729 25.7707 29.2096 25.3074 28.6332 25.3074H7.34363C6.76732 25.3074 6.31531 25.7707 6.31531 26.347C6.31531 26.912 6.76732 27.3866 7.34363 27.3866Z" fill="white" fill-opacity="0.96"/>
                        </svg>
                    </button>
                </div>
            </div> */}
            <div className={styles.nextQueue}>
                {/* <h3>Next in queue</h3> */}
                {localQueue ? 
                    localQueue.queue.length === 0 || localQueue.currently_playing.id === localQueue.queue[0].id ? 
                        <h2>Queue is empty</h2>
                        :
                        <div>
                            {localQueue.queue.map(track => 
                                <div className={styles.queueItem} key={track.id}>
                                    <div className={styles.image} onClick={() => {
                                        console.log("click");
                                        dispatch(playSongRequest({
                                            reqType: "single",
                                            token: token,
                                            tokenType: tokenType,
                                            deviceId: deviceId,
                                            uris: (autoQueueTracks ? autoQueueTracks : track?.uri),
                                            firstTrack: track?.uri
                                        }))
                                    }}>
                                    {/* <div className={track?.id === playerCurrentState?.id ? styles.currentPlayingImage : styles.image}> */}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36" fill="none">
                                            <path d="M12.0109 27.4773C12.4855 27.4773 12.9036 27.3078 13.4234 27.0027L26.769 19.2847C27.7408 18.7197 28.1476 18.2789 28.1476 17.567C28.1476 16.8551 27.7408 16.4257 26.769 15.8494L13.4234 8.13135C12.9036 7.82624 12.4855 7.65674 12.0109 7.65674C11.0843 7.65674 10.4288 8.36865 10.4288 9.48737V25.6467C10.4288 26.7767 11.0843 27.4773 12.0109 27.4773Z" fill="white" fill-opacity="0.96"/>
                                        </svg>
                                        <img src={track.album.images[0].url} alt="" />
                                    </div>
                                    <div className={styles.name}>
                                        <span>
                                            <h4>{track.name.length > 25 ? track.name.slice(0, 25)+" ..." : track.name}</h4>
                                            <p>{fixSongDuration(track.duration_ms)}</p>
                                        </span>
                                        <h5>{track.artists[0].name}</h5>
                                    </div>
                                    <button className={styles.deleteBtn}>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36" fill="none">
                                            <path d="M12.6551 28.9008H23.3564C24.9045 28.9008 25.8085 28.0759 25.8763 26.539L26.5882 10.2102H28.1477C28.724 10.2102 29.1647 9.75821 29.1647 9.1932C29.1647 8.62819 28.7127 8.19878 28.1477 8.19878H23.2434V6.50375C23.2434 4.69571 22.0795 3.62219 20.1358 3.62219H15.8417C13.8981 3.62219 12.7342 4.69571 12.7342 6.50375V8.19878H7.85247C7.28746 8.19878 6.83545 8.63949 6.83545 9.1932C6.83545 9.76951 7.28746 10.2102 7.85247 10.2102H9.4232L10.1464 26.539C10.2029 28.0759 11.1069 28.9008 12.6551 28.9008ZM15.0846 6.60545C15.0846 6.09694 15.4349 5.76923 15.9999 5.76923H19.9889C20.5539 5.76923 20.9042 6.09694 20.9042 6.60545V8.19878H15.0846V6.60545ZM14.3727 25.4316C13.9207 25.4316 13.6043 25.1378 13.593 24.6858L13.254 12.685C13.2427 12.233 13.5591 11.9279 14.0337 11.9279C14.4857 11.9279 14.8021 12.2217 14.8134 12.6737L15.1524 24.6745C15.175 25.1265 14.8586 25.4316 14.3727 25.4316ZM18.0001 25.4316C17.5255 25.4316 17.2091 25.1378 17.2091 24.6858V12.6737C17.2091 12.233 17.5255 11.9279 18.0001 11.9279C18.4747 11.9279 18.8024 12.233 18.8024 12.6737V24.6858C18.8024 25.1378 18.4747 25.4316 18.0001 25.4316ZM21.6274 25.4429C21.1415 25.4429 20.8251 25.1265 20.8477 24.6858L21.1867 12.6737C21.198 12.2217 21.5144 11.9279 21.9664 11.9279C22.4411 11.9279 22.7575 12.233 22.7462 12.685L22.4072 24.6858C22.3959 25.1378 22.0795 25.4429 21.6274 25.4429Z" fill="white" fill-opacity="0.96"/>
                                        </svg>
                                    </button>
                                    {/* <button>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36" fill="none">
                                            <path d="M7.34363 9.6227H28.6332C29.2096 9.6227 29.6729 9.14809 29.6729 8.58308C29.6729 7.99547 29.2096 7.54346 28.6332 7.54346H7.34363C6.76732 7.54346 6.31531 8.00677 6.31531 8.58308C6.31531 9.14809 6.76732 9.6227 7.34363 9.6227ZM7.34363 15.544H28.6332C29.2096 15.544 29.6729 15.0694 29.6729 14.5044C29.6729 13.9168 29.2096 13.4648 28.6332 13.4648H7.34363C6.76732 13.4648 6.31531 13.9281 6.31531 14.5044C6.31531 15.0694 6.76732 15.544 7.34363 15.544ZM7.34363 21.4653H28.6332C29.2096 21.4653 29.6729 20.9907 29.6729 20.4257C29.6729 19.8494 29.2096 19.3861 28.6332 19.3861H7.34363C6.76732 19.3861 6.31531 19.8494 6.31531 20.4257C6.31531 20.9907 6.76732 21.4653 7.34363 21.4653ZM7.34363 27.3866H28.6332C29.2096 27.3866 29.6729 26.912 29.6729 26.347C29.6729 25.7707 29.2096 25.3074 28.6332 25.3074H7.34363C6.76732 25.3074 6.31531 25.7707 6.31531 26.347C6.31531 26.912 6.76732 27.3866 7.34363 27.3866Z" fill="white" fill-opacity="0.96"/>
                                        </svg>
                                    </button> */}
                                </div>
                            )}
                        </div>
                    :
                    null
                }
            </div>
        </div>
    </div>
  )
}

export default Queue